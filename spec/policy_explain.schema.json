{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://lexlattice.local/spec/policy_explain.schema.json",
  "title": "policy_explain@1",
  "type": "object",
  "required": [
    "schema",
    "valid",
    "deterministic_mode",
    "issues"
  ],
  "properties": {
    "schema": {
      "const": "policy_explain@1"
    },
    "valid": {
      "type": "boolean"
    },
    "deterministic_mode": {
      "type": "boolean"
    },
    "strict": {
      "type": "boolean"
    },
    "input_policy": {
      "type": "string"
    },
    "input_context": {
      "type": "string"
    },
    "input_decision": {
      "type": "string"
    },
    "evaluation_ts": {
      "type": "string",
      "pattern": "^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}Z$"
    },
    "policy_hash": {
      "$ref": "#/$defs/hash"
    },
    "input_context_hash": {
      "$ref": "#/$defs/hash"
    },
    "decision": {
      "enum": [
        "allow",
        "deny"
      ]
    },
    "decision_code": {
      "type": "string",
      "minLength": 1
    },
    "matched_rule_ids": {
      "type": "array",
      "items": {
        "type": "string",
        "minLength": 1
      }
    },
    "matched_rules": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/matchedRule"
      }
    },
    "required_approval": {
      "type": "boolean"
    },
    "evaluator_version": {
      "type": "string",
      "minLength": 1
    },
    "trace_version": {
      "type": "string",
      "minLength": 1
    },
    "policy_schema_version": {
      "type": "string",
      "minLength": 1
    },
    "policy_ir_version": {
      "type": "string",
      "minLength": 1
    },
    "advisories": {
      "type": "array",
      "items": {
        "type": "object"
      }
    },
    "warrant_invalid": {
      "type": "boolean"
    },
    "evidence_refs": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/evidenceRef"
      }
    },
    "input_manifest": {
      "$ref": "#/$defs/inputManifest"
    },
    "issues": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/issue"
      }
    }
  },
  "allOf": [
    {
      "if": {
        "properties": {
          "valid": {
            "const": true
          }
        },
        "required": [
          "valid"
        ]
      },
      "then": {
        "required": [
          "strict",
          "evaluation_ts",
          "policy_hash",
          "input_context_hash",
          "decision",
          "decision_code",
          "matched_rule_ids",
          "matched_rules",
          "required_approval",
          "evaluator_version",
          "trace_version",
          "policy_schema_version",
          "policy_ir_version",
          "advisories",
          "warrant_invalid",
          "evidence_refs",
          "input_manifest"
        ]
      }
    }
  ],
  "$defs": {
    "hash": {
      "type": "string",
      "pattern": "^[a-f0-9]{64}$"
    },
    "evidenceRef": {
      "type": "object",
      "required": [
        "kind",
        "ref"
      ],
      "properties": {
        "kind": {
          "enum": [
            "event",
            "run",
            "validator",
            "proof",
            "artifact"
          ]
        },
        "ref": {
          "type": "string",
          "minLength": 1
        },
        "note": {
          "type": [
            "string",
            "null"
          ]
        }
      },
      "additionalProperties": false
    },
    "matchedRule": {
      "type": "object",
      "required": [
        "rule_id",
        "rule_version",
        "priority",
        "kind",
        "code",
        "effect",
        "message"
      ],
      "properties": {
        "rule_id": {
          "type": "string",
          "minLength": 1
        },
        "rule_version": {
          "type": "integer",
          "minimum": 1
        },
        "priority": {
          "type": "integer"
        },
        "kind": {
          "enum": [
            "deny",
            "allow",
            "require",
            "derive"
          ]
        },
        "code": {
          "type": "string",
          "minLength": 1
        },
        "effect": {
          "type": "string",
          "minLength": 1
        },
        "message": {
          "type": "string"
        }
      },
      "additionalProperties": true
    },
    "inputManifest": {
      "type": "object",
      "required": [
        "policy_hash",
        "input_context_hash",
        "evaluation_ts",
        "evidence_refs",
        "decision_trace_hash"
      ],
      "properties": {
        "policy_hash": {
          "$ref": "#/$defs/hash"
        },
        "input_context_hash": {
          "$ref": "#/$defs/hash"
        },
        "evaluation_ts": {
          "type": "string",
          "pattern": "^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}Z$"
        },
        "evidence_refs": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/evidenceRef"
          }
        },
        "decision_trace_hash": {
          "$ref": "#/$defs/hash"
        }
      },
      "additionalProperties": true
    },
    "issue": {
      "type": "object",
      "required": [
        "code",
        "message",
        "context"
      ],
      "properties": {
        "code": {
          "type": "string",
          "minLength": 1
        },
        "message": {
          "type": "string",
          "minLength": 1
        },
        "context": {
          "type": "object"
        }
      },
      "additionalProperties": true
    }
  },
  "additionalProperties": true
}
